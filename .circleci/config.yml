---
version: 2.1

orbs:
  toolkit: jerus-org/circleci-toolkit@0.2.1

parameters:
  min-rust-version:
    type: string
    default: "1.61"

executors:
  rust-env:
    docker:
      - image: jerusdp/ci-rust:<<pipeline.parameters.min-rust-version>>

jobs:
  required-builds:
    executor: rust-env
    steps:
      - checkout
      - run: cargo --version
      - toolkit/cargo_build:
          rust_version: "stable"
      - toolkit/cargo_build:
          rust_version: "<<pipeline.parameters.min-rust-version>>"

  optional-builds:
    executor: rust-env
    steps:
      - checkout
      - run: cargo --version
      - toolkit/cargo_build:
          rust_version: "nightly"
      - toolkit/cargo_build:
          rust_version: "beta"

  all-features-flag-test:
    executor: rust-env
    steps:
      - checkout
      - run: cargo --version
      - run:
          name: Test all features of the crate
          command: "cargo test --all-features"

  feature-test:
    parameters:
      mockd-feature:
        type: string
    executor: rust-env
    steps:
      - checkout
      - run: cargo --version
      - run:
          name: Test <<parameters.mockd-feature>> features of the crate
          command: "cargo test --features <<parameters.mockd-feature>>"

  docs:
    executor: rust-env
    environment:
      RUSTDOCFLAGS: --cfg docsrs -Dwarnings
    steps:
      - checkout
      - run:
          name: Test generation of all of the documentation for the crate
          command: |
            cargo +nightly doc \
            --lib \
            --no-deps \
            --all-features \
            --document-private-items

  release-ready:
    executor: rust-env
    steps:
      - checkout
      - run:
          name: Check if ready to make a release
          command: |
            set -eo pipefail

            if [ "$(nextsv -q)" != "none" ]
            then
              exit 0
            else
             exit 1
            fi

  make-release:
    executor: rust-env
    steps:
      - checkout
      - run:
          name: import GPG key
          command: |
            echo -e $GPGKEY \
              | base64 --decode --ignore-garbage \
              | gpg --batch --allow-secret-key-import --import
            gpg --keyid-format  LONG --list-secret-keys
      - run:
          name: Configure git for user and signing
          command: |
            git config user.email "$USER_EMAIL"
            git config user.name "$USER_NAME"
            git config --global gpg.program gpg
            git config --global user.signingkey "$SIGNKEY"
      - run:
          name: Publish update
          command: |
            set -exo pipefail
            export NEXTSV_LEVEL=\
            $(nextsv -q \
            -c other \
            require \
            -f CHANGES.md -f CHANGELOG.md feature)
            if [ $NEXTSV_LEVEL != "none" ] ; then
              cargo release changes
              cargo release \
              -vvv \
              --execute \
              --no-confirm \
              --sign-tag \
              "$NEXTSV_LEVEL"
            else
              echo "Not ready to release yet."
            fi

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  validation:
    when:
      not:
        equal: [scheduled_pipeline, << pipeline.trigger_source >>]
    jobs:
      - required-builds
      - toolkit/common_tests
      - feature-test:
          matrix:
            parameters:
              mockd-feature:
                [
                  all,
                  address,
                  animal,
                  beer,
                  company,
                  contact,
                  currency,
                  datetime,
                  file,
                  generator,
                  hacker,
                  hipster,
                  image,
                  internet,
                  job,
                  language,
                  log-level,
                  name,
                  password,
                  payment,
                  person,
                  random-bool,
                  status-code,
                  unique,
                  user-agent,
                  vehicle,
                  words,
                ]
          requires:
            - toolkit/common_tests
            - required-builds
            - docs
      - all-features-flag-test:
          requires:
            - feature-test
      # - pr-changelog-update:
      - toolkit/update_changelog:
          requires:
            - all-features-flag-test
          context:
            - release
          ssh_fingerprint: SHA256:OkxsH8Z6Iim6WDJBaII9eTT9aaO1f3eDc6IpsgYYPVg
      - optional-builds
      - docs
      - optional-builds
  release:
    when:
      and:
        - equal: [scheduled_pipeline, << pipeline.trigger_source >>]
        - equal: ["release check", << pipeline.schedule.name >>]
    jobs:
      - release-ready
      - make-release:
          requires:
            - release-ready
          context:
            - release
